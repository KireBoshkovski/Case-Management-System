<!-- edit-case.html -->
@if (loading) {
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading case data...</p>
    </div>
}

@if (!loading && caseForm) {
    <div class="case-edit-container">
        <div class="header-section">
            <h1>Review and Publish Case</h1>
            <p class="subtitle">Review the anonymized case data below before publishing to the public database.</p>
        </div>

        <form [formGroup]="caseForm" class="case-form">
            <!-- Alert Section -->
            <div class="alert-section">
                <div class="alert alert-info">
                    <div class="alert-icon">ℹ️</div>
                    <div class="alert-content">
                        <strong>Anonymization Applied:</strong> Personal identifying information has been automatically removed from all text fields. Please review and make any additional edits as needed.
                    </div>
                </div>
            </div>

            <!-- Main Case Information -->
            <div class="form-section">
                <h2>Case Information</h2>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="description">
                            Description <span class="required">*</span>
                            <span class="anonymized-badge">Anonymized</span>
                        </label>
                        <textarea
                            id="description"
                            formControlName="description"
                            rows="4"
                            placeholder="Enter case description..."
                            class="form-control"></textarea>
                        <small class="help-text">Main case description with identifying information removed</small>
                        @if (caseForm.get('description')?.invalid && caseForm.get('description')?.touched) {
                            <div class="error-text">Description is required</div>
                        }
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="treatmentPlan">
                            Treatment Plan
                            <span class="anonymized-badge">Anonymized</span>
                        </label>
                        <textarea
                            id="treatmentPlan"
                            formControlName="treatmentPlan"
                            rows="4"
                            placeholder="Enter treatment plan..."
                            class="form-control"></textarea>
                        <small class="help-text">Treatment plan with identifying information removed</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bloodType">Blood Type</label>
                        <select id="bloodType" formControlName="bloodType" class="form-control">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="status">Case Status</label>
                        <select id="status" formControlName="status" class="form-control">
                            <option value="ACTIVE">Active</option>
                            <option value="CLOSED">Closed</option>
                            <option value="IN_PROGRESS">In Progress</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="allergies">
                            Allergies
                            <span class="anonymized-badge">Anonymized</span>
                        </label>
                        <textarea
                            id="allergies"
                            formControlName="allergies"
                            rows="2"
                            placeholder="Enter known allergies..."
                            class="form-control"></textarea>
                        <small class="help-text">Known allergies with identifying information removed</small>
                    </div>
                </div>
            </div>

            <!-- Patient Information (Anonymized) -->
            <div class="form-section">
                <h2>Patient Information (Anonymized)</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="patientAgeRange">Age Range</label>
                        <input
                            id="patientAgeRange"
                            formControlName="patientAgeRange"
                            readonly
                            class="form-control readonly"
                            placeholder="Age range will be calculated" />
                        <small class="help-text">Automatically calculated from patient's date of birth</small>
                    </div>

                    <div class="form-group">
                        <label for="patientGender">
                            Gender <span class="required">*</span>
                        </label>
                        <select id="patientGender" formControlName="patientGender" class="form-control">
                            <option value="">Select Gender</option>
                            <option value="MALE">Male</option>
                            <option value="FEMALE">Female</option>
                            <option value="OTHER">Other</option>
                            <option value="UNKNOWN">Unknown</option>
                        </select>
                        @if (caseForm.get('patientGender')?.invalid && caseForm.get('patientGender')?.touched) {
                            <div class="error-text">Gender selection is required</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Case Metadata -->
            <div class="form-section">
                <h2>Case Metadata</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="createdAt">Original Created Date</label>
                        <input
                            id="createdAt"
                            [value]="caseForm.get('createdAt')?.value | date: 'short'"
                            disabled
                            class="form-control disabled" />
                    </div>

                    <div class="form-group">
                        <label for="updatedAt">Last Updated</label>
                        <input
                            id="updatedAt"
                            [value]="caseForm.get('updatedAt')?.value | date: 'short'"
                            disabled
                            class="form-control disabled" />
                    </div>
                </div>
            </div>

            <!-- Examinations Section -->
            @if (examinationsFormArray && examinationsFormArray.length > 0) {
                <div class="form-section examinations-section">
                    <h2>Examinations ({{ examinationsFormArray.length }})</h2>
                    <p class="info-text">
                        Review and edit the anonymized examination data below. Personal information has been automatically removed.
                    </p>

                    <div class="examinations-container">
                        @for (examination of examinationsFormArray.controls; track $index; let i = $index) {
                            <div class="examination-form-card" [formGroup]="getExaminationFormGroup(i)">
                                <div class="exam-card-header">
                                    <h3>Examination {{ i + 1 }}</h3>
                                    <span class="anonymized-badge">Anonymized</span>
                                </div>

                                <!-- Hidden fields -->
                                <input type="hidden" formControlName="id">
                                <input type="hidden" formControlName="originalExaminationId">

                                <!-- Examination Type -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="examinationType-{{i}}">
                                            Examination Type <span class="required">*</span>
                                        </label>
                                        <input
                                            id="examinationType-{{i}}"
                                            formControlName="examinationType"
                                            class="form-control"
                                            placeholder="e.g., Blood Test, X-Ray, Physical Exam" />
                                        @if (getExaminationFormGroup(i).get('examinationType')?.invalid && getExaminationFormGroup(i).get('examinationType')?.touched) {
                                            <div class="error-text">Examination type is required</div>
                                        }
                                    </div>

                                    <div class="form-group">
                                        <label for="examiningDoctorSpecialty-{{i}}">Doctor Specialty</label>
                                        <input
                                            id="examiningDoctorSpecialty-{{i}}"
                                            formControlName="examiningDoctorSpecialty"
                                            class="form-control"
                                            placeholder="e.g., Cardiology, Radiology" />
                                    </div>
                                </div>

                                <!-- Examination Date -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="examinationDate-{{i}}">Examination Date</label>
                                        <input
                                            id="examinationDate-{{i}}"
                                            type="datetime-local"
                                            formControlName="examinationDate"
                                            class="form-control" />
                                    </div>
                                </div>

                                <!-- Findings -->
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="findings-{{i}}">
                                            Findings
                                            <span class="anonymized-badge">Anonymized</span>
                                        </label>
                                        <textarea
                                            id="findings-{{i}}"
                                            formControlName="findings"
                                            rows="3"
                                            class="form-control"
                                            placeholder="Clinical findings and observations..."></textarea>
                                        <small class="help-text">Clinical findings with identifying information removed</small>
                                    </div>
                                </div>

                                <!-- Results -->
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="results-{{i}}">
                                            Results
                                            <span class="anonymized-badge">Anonymized</span>
                                        </label>
                                        <textarea
                                            id="results-{{i}}"
                                            formControlName="results"
                                            rows="3"
                                            class="form-control"
                                            placeholder="Test results and measurements..."></textarea>
                                        <small class="help-text">Test results with identifying information removed</small>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="notes-{{i}}">
                                            Notes
                                            <span class="anonymized-badge">Anonymized</span>
                                        </label>
                                        <textarea
                                            id="notes-{{i}}"
                                            formControlName="notes"
                                            rows="2"
                                            class="form-control"
                                            placeholder="Additional notes and observations..."></textarea>
                                        <small class="help-text">Additional notes with identifying information removed</small>
                                    </div>
                                </div>

                                <!-- Vital Signs -->
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="vitalSigns-{{i}}">Vital Signs (JSON Format)</label>
                                        <textarea
                                            id="vitalSigns-{{i}}"
                                            formControlName="vitalSigns"
                                            rows="2"
                                            class="form-control code-input"
                                            placeholder='{"bloodPressure": "120/80", "heartRate": "72", "temperature": "98.6"}'></textarea>
                                        <small class="help-text">Vital signs data in JSON format</small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            } @else if (originalCase && (!originalCase.examinations || originalCase.examinations.length === 0)) {
                <div class="form-section">
                    <h2>Examinations</h2>
                    <div class="no-examinations">
                        <p class="info-text">No examinations found for this case.</p>
                    </div>
                </div>
            }

            <!-- Warning Section -->
            <div class="form-section warning-section">
                <div class="alert alert-warning">
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <h3>Publishing Confirmation</h3>
                        <p>By clicking "Confirm Publish", you confirm that:</p>
                        <ul class="confirmation-list">
                            <li>All personal information has been properly anonymized</li>
                            <li>This case contains educational value for the medical community</li>
                            <li>You have the authority to publish this case data</li>
                            <li>The published case will be publicly accessible</li>
                            <li>Published data cannot be easily removed once published</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button
                    type="button"
                    class="btn btn-secondary"
                    (click)="goBack()"
                    [disabled]="saving">
                    <span class="btn-icon">←</span>
                    Cancel
                </button>

                <button
                    type="button"
                    class="btn btn-primary"
                    (click)="confirmPublish()"
                    [disabled]="saving || caseForm.invalid">
                    @if (saving) {
                        <span class="spinner small"></span>
                        Publishing...
                    } @else {
                        <span class="btn-icon">✓</span>
                        Confirm Publish
                    }
                </button>
            </div>

            <!-- Error Display -->
            @if (errorMessage) {
                <div class="alert alert-error">
                    <div class="alert-icon">❌</div>
                    <div class="alert-content">
                        <strong>Error:</strong> {{ errorMessage }}
                    </div>
                </div>
            }
        </form>
    </div>
}

@if (!loading && !caseForm && errorMessage) {
    <div class="error-container">
        <div class="error-content">
            <h2>Unable to Load Case</h2>
            <p>{{ errorMessage }}</p>
            <button class="btn btn-primary" (click)="goBack()">
                ← Back to Cases
            </button>
        </div>
    </div>
}
