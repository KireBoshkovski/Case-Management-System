<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header Card -->
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-white">
                    <h1 class="h4 mb-1">Publish Case #{{ caseId }}</h1>
                    <p class="text-muted mb-0">Review and edit the case content before publishing it publicly</p>
                </div>
            </div>

            @if (originalCase) {
                <!-- Original Case Preview -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-file-medical me-2"></i>
                            Original Case Information
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <strong>Patient:</strong>
                                <span class="text-muted">{{ originalCase.patient.firstName }} {{ originalCase.patient.lastName }}</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong>Doctor:</strong>
                                <span class="text-muted">{{ originalCase.doctor.firstName }} {{ originalCase.doctor.lastName }}</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <strong>Status:</strong>
                                <span class="badge badge-primary">{{ originalCase.status }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Censoring Section -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-shield-check me-2"></i>
                            AI Content Censoring
                        </h2>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Use AI to automatically remove sensitive information before publishing.
                        </p>
                        <button
                            type="button"
                            class="btn btn-primary"
                            (click)="requestCensoring()"
                            [disabled]="censoring"
                        >
                            @if (censoring) {
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Censoring Content...
                            } @else {
                                @if (hasCensoredData()) {
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    Re-censor Content
                                } @else {
                                    <i class="bi bi-shield-check me-2"></i>
                                    Censor Content with AI
                                }
                            }
                        </button>
                    </div>
                </div>

                <!-- Publishing Form -->
                @if (hasCensoredData() || !censoring) {
                    <form [formGroup]="publishForm" (ngSubmit)="publishCase()">
                        <!-- Medical Information -->
                        <div class="card mb-4 shadow-sm border-0">
                            <div class="card-header bg-light">
                                <h2 class="h5 mb-0">
                                    <i class="bi bi-clipboard-data me-2"></i>
                                    Medical Information
                                </h2>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label for="description" class="form-label fw-semibold">Description *</label>
                                        <textarea
                                            id="description"
                                            class="form-control"
                                            [class.is-invalid]="isFieldInvalid('description')"
                                            formControlName="description"
                                            placeholder="Case description (sensitive info should be removed)"
                                            rows="4"
                                        ></textarea>
                                        @if (isFieldInvalid("description")) {
                                            <div class="invalid-feedback">{{ getFieldError("description") }}</div>
                                        }
                                    </div>

                                    <div class="col-12 mb-3">
                                        <label for="treatmentPlan" class="form-label fw-semibold">Treatment Plan</label>
                                        <textarea
                                            id="treatmentPlan"
                                            class="form-control"
                                            formControlName="treatmentPlan"
                                            placeholder="Treatment plan (sensitive info should be removed)"
                                            rows="4"
                                        ></textarea>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="bloodType" class="form-label fw-semibold">Blood Type</label>
                                        <select id="bloodType" class="form-select" formControlName="bloodType">
                                            <option value="">Select blood type</option>
                                            <option value="A+">A+</option>
                                            <option value="A-">A-</option>
                                            <option value="B+">B+</option>
                                            <option value="B-">B-</option>
                                            <option value="AB+">AB+</option>
                                            <option value="AB-">AB-</option>
                                            <option value="O+">O+</option>
                                            <option value="O-">O-</option>
                                        </select>
                                    </div>

                                    <div class="col-12 mb-3">
                                        <label for="allergies" class="form-label fw-semibold">Allergies</label>
                                        <textarea
                                            id="allergies"
                                            class="form-control"
                                            formControlName="allergies"
                                            placeholder="Known allergies (sensitive info should be removed)"
                                            rows="3"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Examinations Section -->
                        <div class="card mb-4 shadow-sm border-0">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h2 class="h5 mb-0">
                                    <i class="bi bi-clipboard-pulse me-2"></i>
                                    Examinations
                                </h2>
                                @if (originalCase.examinations && originalCase.examinations.length > 0) {
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary btn-sm"
                                        (click)="addExamination()"
                                    >
                                        <i class="bi bi-plus"></i> Add New Examination
                                    </button>
                                }
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-4">
                                    Edit examination data to remove sensitive information before publishing.
                                </p>

                                @if (originalCase.examinations && originalCase.examinations.length > 0) {
                                    <div formArrayName="examinations">
                                        @for (examination of getExaminationsFormArray().controls; track examination; let i = $index) {
                                            <div [formGroupName]="i" class="card border-light mb-4">
                                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                                    <h3 class="h6 mb-0">
                                                        <i class="bi bi-clipboard-data me-2"></i>
                                                        Examination {{ i + 1 }}
                                                    </h3>
                                                    <button
                                                        type="button"
                                                        class="btn btn-outline-danger btn-sm"
                                                        (click)="removeExamination(i)"
                                                    >
                                                        <i class="bi bi-trash"></i> Remove
                                                    </button>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label [for]="'exam-type-' + i" class="form-label fw-semibold">Examination Type *</label>
                                                            <input
                                                                [id]="'exam-type-' + i"
                                                                type="text"
                                                                class="form-control"
                                                                [class.is-invalid]="examination.get('examinationType')?.invalid && examination.get('examinationType')?.touched"
                                                                formControlName="examinationType"
                                                                placeholder="e.g., Blood Test, X-Ray, MRI"
                                                            />
                                                            @if (examination.get("examinationType")?.invalid && examination.get("examinationType")?.touched) {
                                                                <div class="invalid-feedback">Examination type is required</div>
                                                            }
                                                        </div>

                                                        <div class="col-md-6 mb-3">
                                                            <label [for]="'exam-date-' + i" class="form-label fw-semibold">Examination Date *</label>
                                                            <input
                                                                [id]="'exam-date-' + i"
                                                                type="date"
                                                                class="form-control"
                                                                [class.is-invalid]="examination.get('examinationDate')?.invalid && examination.get('examinationDate')?.touched"
                                                                formControlName="examinationDate"
                                                            />
                                                            @if (examination.get("examinationDate")?.invalid && examination.get("examinationDate")?.touched) {
                                                                <div class="invalid-feedback">Examination date is required</div>
                                                            }
                                                        </div>

                                                        <div class="col-md-6 mb-3">
                                                            <label [for]="'exam-findings-' + i" class="form-label fw-semibold">Findings</label>
                                                            <textarea
                                                                [id]="'exam-findings-' + i"
                                                                class="form-control"
                                                                formControlName="findings"
                                                                placeholder="Examination findings (sensitive info should be removed)"
                                                                rows="3"
                                                            ></textarea>
                                                        </div>

                                                        <div class="col-md-6 mb-3">
                                                            <label [for]="'exam-results-' + i" class="form-label fw-semibold">Results</label>
                                                            <textarea
                                                                [id]="'exam-results-' + i"
                                                                class="form-control"
                                                                formControlName="results"
                                                                placeholder="Examination results (sensitive info should be removed)"
                                                                rows="3"
                                                            ></textarea>
                                                        </div>

                                                        <div class="col-md-6 mb-3">
                                                            <label [for]="'exam-notes-' + i" class="form-label fw-semibold">Notes</label>
                                                            <textarea
                                                                [id]="'exam-notes-' + i"
                                                                class="form-control"
                                                                formControlName="notes"
                                                                placeholder="Additional notes (sensitive info should be removed)"
                                                                rows="2"
                                                            ></textarea>
                                                        </div>

                                                        <div class="col-md-6 mb-3">
                                                            <label [for]="'exam-vital-signs-' + i" class="form-label fw-semibold">Vital Signs</label>
                                                            <textarea
                                                                [id]="'exam-vital-signs-' + i"
                                                                class="form-control"
                                                                formControlName="vitalSigns"
                                                                placeholder="Vital signs data (sensitive info should be removed)"
                                                                rows="2"
                                                            ></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                } @else {
                                    <div class="text-center py-4 text-muted">
                                        <i class="bi bi-clipboard-data fs-1 d-block mb-2"></i>
                                        <p class="mb-3">No examinations found for this case.</p>
                                        <button
                                            type="button"
                                            class="btn btn-primary"
                                            (click)="addExamination()"
                                        >
                                            <i class="bi bi-plus"></i> Add Examination
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Anonymized Patient Information -->
                        <div class="card mb-4 shadow-sm border-0">
                            <div class="card-header bg-light">
                                <h2 class="h5 mb-0">
                                    <i class="bi bi-person-check me-2"></i>
                                    Anonymized Patient Information
                                </h2>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="patientAgeRange" class="form-label fw-semibold">Patient Age Range *</label>
                                        <select
                                            id="patientAgeRange"
                                            class="form-select"
                                            [class.is-invalid]="isFieldInvalid('patientAgeRange')"
                                            formControlName="patientAgeRange"
                                        >
                                            <option value="">Select age range</option>
                                            <option value="Under 18">Under 18</option>
                                            <option value="18-29">18-29</option>
                                            <option value="30-44">30-44</option>
                                            <option value="45-59">45-59</option>
                                            <option value="60-74">60-74</option>
                                            <option value="75+">75+</option>
                                        </select>
                                        @if (isFieldInvalid("patientAgeRange")) {
                                            <div class="invalid-feedback">{{ getFieldError("patientAgeRange") }}</div>
                                        }
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="patientGender" class="form-label fw-semibold">Patient Gender *</label>
                                        <select
                                            id="patientGender"
                                            class="form-select"
                                            [class.is-invalid]="isFieldInvalid('patientGender')"
                                            formControlName="patientGender"
                                        >
                                            <option value="">Select gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                            <option value="Prefer not to say">Prefer not to say</option>
                                        </select>
                                        @if (isFieldInvalid("patientGender")) {
                                            <div class="invalid-feedback">{{ getFieldError("patientGender") }}</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error Message -->
                        @if (errorMessage) {
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {{ errorMessage }}
                            </div>
                        }

                        <!-- Publishing Actions -->
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <div class="d-flex gap-2">
                                    <button
                                        type="submit"
                                        class="btn btn-success"
                                        [disabled]="publishing || publishForm.invalid"
                                    >
                                        @if (publishing) {
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Publishing Case...
                                        } @else {
                                            <i class="bi bi-cloud-upload me-2"></i>
                                            Publish Case
                                        }
                                    </button>

                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        (click)="router.navigate(['/cases', caseId])"
                                    >
                                        <i class="bi bi-x-circle me-2"></i>
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                }
            }
        </div>
    </div>
</div>
